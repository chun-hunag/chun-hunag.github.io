<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jam-boxes.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"disqus","active":true,"storage":true,"lazyload":true,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Build a RabbitMQ cluster including HAPorxy by docker-composer This article is composed of this part:  Why do we need a RabbitMQ cluster? How many ways we can build a RabbitMQ cluster and which way is">
<meta property="og:type" content="article">
<meta property="og:title" content="Build a RabbitMQ cluster including HAPorxy by docker-composer">
<meta property="og:url" content="https://jam-boxes.com/build-a-rabbitmq-cluster-including-haporxy-by-docker-composer/index.html">
<meta property="og:site_name" content="Jam&#39;s Box">
<meta property="og:description" content="Build a RabbitMQ cluster including HAPorxy by docker-composer This article is composed of this part:  Why do we need a RabbitMQ cluster? How many ways we can build a RabbitMQ cluster and which way is">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://jam-boxes.com/images/002.Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-compose/002-image.png">
<meta property="og:image" content="https://jam-boxes.com/images/002.Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-compose/002-image%201.png">
<meta property="og:image" content="https://jam-boxes.com/images/002.Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-compose/002-image%202.png">
<meta property="og:image" content="https://jam-boxes.com/images/002.Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-compose/002-image%203.png">
<meta property="og:image" content="https://jam-boxes.com/images/002.Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-compose/002-image%204.png">
<meta property="article:published_time" content="2022-05-15T02:38:57.000Z">
<meta property="article:modified_time" content="2022-05-16T00:42:22.000Z">
<meta property="article:author" content="jam huang">
<meta property="article:tag" content="RabbitMQ">
<meta property="article:tag" content="Docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jam-boxes.com/images/002.Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-compose/002-image.png">

<link rel="canonical" href="https://jam-boxes.com/build-a-rabbitmq-cluster-including-haporxy-by-docker-composer/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Build a RabbitMQ cluster including HAPorxy by docker-composer | Jam's Box</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Jam's Box</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Leaning Note</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/chun-hunag" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://jam-boxes.com/build-a-rabbitmq-cluster-including-haporxy-by-docker-composer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Tombili_mini.jpg">
      <meta itemprop="name" content="jam huang">
      <meta itemprop="description" content="Share tech notes and investment experience">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jam's Box">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Build a RabbitMQ cluster including HAPorxy by docker-composer
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-15 02:38:57" itemprop="dateCreated datePublished" datetime="2022-05-15T02:38:57+00:00">2022-05-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-16 00:42:22" itemprop="dateModified" datetime="2022-05-16T00:42:22+00:00">2022-05-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-composer"><a href="#Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-composer" class="headerlink" title="Build a RabbitMQ cluster including HAPorxy by docker-composer"></a>Build a RabbitMQ cluster including HAPorxy by docker-composer</h1><hr>
<p>This article is composed of this part:</p>
<ul>
<li>Why do we need a RabbitMQ cluster?</li>
<li>How many ways we can build a RabbitMQ cluster and which way is this article used?</li>
<li>Some things we need to know before starting</li>
<li>Build RabbitMQ cluster through CLI command manually</li>
<li>Build RabbitMQ cluster through docker-composer</li>
<li>Add HAProxy as load balance.</li>
<li>Build by docker-compose</li>
<li>Completed <code>docker-compose.yml</code> and directory structure</li>
<li>Source code</li>
</ul>
<h2 id="Why-do-we-need-a-RabbitMQ-cluster"><a href="#Why-do-we-need-a-RabbitMQ-cluster" class="headerlink" title="Why do we need a RabbitMQ cluster?"></a>Why do we need a RabbitMQ cluster?</h2><hr>
<p>Make sure that Producer and Consumer can still work even if one of a node in the cluster failed.</p>
<p>The cluster provides higher stability and also sacrifices part of the performance. </p>
<p>Because nodes in the clusters have to sync messages to each other, this means that the more nodes exist in the cluster, the more time will be costed on syncing messages to each other.</p>
<h2 id="How-many-ways-we-can-build-RabbitMQ-cluster"><a href="#How-many-ways-we-can-build-RabbitMQ-cluster" class="headerlink" title="How many ways we can build  RabbitMQ cluster ?"></a>How many ways we can build  RabbitMQ cluster ?</h2><hr>
<p>According to rabbitmq’s official website, there are several ways to form a cluster:</p>
<ul>
<li><strong>Declaratively by listing cluster nodes in config file</strong></li>
<li><strong>Declaratively using DNS-based discovery</strong></li>
<li>Declaratively using AWS (EC2) instance discovery (via a plugin)</li>
<li>Declaratively using Kubernetes discovery (via a plugin)</li>
<li>Declaratively using Consul-based discovery (via a plugin)</li>
<li>Declaratively using Consul-based discovery (via a plugin)</li>
<li><strong>Manually with <code>rabbitmqctl</code></strong></li>
</ul>
<p>In this article, we will describe how to form rabbitmq cluster </p>
<p>throught  <strong><code>rabbitmqctl</code> and use docker-compose to make this process automated.</strong></p>
<h2 id="Some-things-we-need-to-know-before-starting"><a href="#Some-things-we-need-to-know-before-starting" class="headerlink" title="Some things we need to know before starting"></a>Some things we need to know before starting</h2><hr>
<ul>
<li><p>The RabbitMQ cluster is based on Erlang. We need to start the Erlang node before we build the cluster.</p>
<p>  The communication between Erlang nodes is relying on Erlang Cookies, so we need to make all RabbitMQ nodes’ Erlang Cookies value the same.</p>
</li>
</ul>
<h2 id="Build-RabbitMQ-cluster-through-rabbitmqctl-manually"><a href="#Build-RabbitMQ-cluster-through-rabbitmqctl-manually" class="headerlink" title="Build RabbitMQ cluster through rabbitmqctl manually"></a>Build RabbitMQ cluster through <strong><code>rabbitmqctl</code></strong> manually</h2><hr>
<h3 id="Run-three-RabbitMQ-container"><a href="#Run-three-RabbitMQ-container" class="headerlink" title="Run three RabbitMQ container"></a>Run three RabbitMQ container</h3><hr>
<ul>
<li><code>docker run -d --hostname rabbitmq01 --name rabbit01 -e RABBITMQ_DEFAULT_USER=guest -e RABBITMQ_DEFAULT_PASS=guest -e RABBITMQ_ERLANG_COOKIE=myerlangcookies -p 5672:5672 -p 15672:15672 rabbitmq:3.9-management</code></li>
<li><code>docker run -d --hostname rabbitmq02 --name rabbit02 -e RABBITMQ_DEFAULT_USER=guest -e RABBITMQ_DEFAULT_PASS=guest -e RABBITMQ_ERLANG_COOKIE=myerlangcookies -p 5673:5672 -p 15673:15672 rabbitmq:3.9-management</code></li>
<li><code>docker run -d --hostname rabbitmq03 --name rabbit03 -e RABBITMQ_DEFAULT_USER=guest -e RABBITMQ_DEFAULT_PASS=guest -e RABBITMQ_ERLANG_COOKIE=myerlangcookies -p 5674:5672 -p 15674:15672 rabbitmq:3.9-management</code></li>
</ul>
<h3 id="Check-Management-UI"><a href="#Check-Management-UI" class="headerlink" title="Check Management UI"></a>Check Management UI</h3><hr>
<ul>
<li><p><a target="_blank" rel="noopener" href="http://127.0.0.1:15672/#/">http://127.0.0.1:15672/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://127.0.0.1:15672/#/">http://127.0.0.1:15673/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://127.0.0.1:15672/#/">http://127.0.0.1:15674/</a></p>
<p>  <img src="/../images/002.Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-compose/002-image.png" alt="Untitled"></p>
</li>
</ul>
<h3 id="Get-IP-of-rabbitmq-containers"><a href="#Get-IP-of-rabbitmq-containers" class="headerlink" title="Get IP of rabbitmq containers"></a>Get IP of rabbitmq containers</h3><hr>
<ul>
<li><p><code>docker exec -it rabbit01 hostname -I</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">172.17.0.2</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>docker exec -it rabbit02 hostname -I</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">172.17.0.3</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>docker exec -it rabbit03 hostname -I</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">172.17.0.4</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Add-IP-to-container’s-hosts"><a href="#Add-IP-to-container’s-hosts" class="headerlink" title="Add IP to container’s hosts"></a>Add IP to container’s hosts</h3><hr>
<ul>
<li><p><code>docker exec -it rabbit01 bash</code>  &amp; <code>docker exec -it rabbit02 bash</code>  &amp; <code>docker exec -it rabbit03 bash</code></p>
</li>
<li><p><code>apt-get update</code></p>
</li>
<li><p><code>apt-get install vim</code></p>
</li>
<li><p><code>vi /etc/hosts</code></p>
<p>  Add this line (replace IP to the IP you get previous step):</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.17.0.2      rabbitmq01</span><br><span class="line">172.17.0.3      rabbitmq02</span><br><span class="line">172.17.0.4      rabbitmq03</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="RabbitMQ-2-and-3-join-cluster"><a href="#RabbitMQ-2-and-3-join-cluster" class="headerlink" title="RabbitMQ 2 and 3 join cluster"></a>RabbitMQ 2 and 3 join cluster</h3><hr>
<ul>
<li><p>Login rabbit02 &amp; rabbit03:</p>
<p>   <code>docker exec -it rabbit02 bash</code></p>
</li>
<li><p>stop rabbitmq application:</p>
<p>  <code>rabbitmqctl stop_app</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rabbitmqctl stop_app</span><br><span class="line">Stopping rabbit application on node rabbit@rabbitmq02 ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>Join Cluster:</p>
<p>  <code>rabbitmqctl join_cluster rabbit@rabbitmq01</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rabbitmqctl join_cluster rabbit@rabbitmq01</span></span><br><span class="line">Clustering node rabbit@rabbitmq02 with rabbit@rabbitmq01</span><br></pre></td></tr></table></figure>
</li>
<li><p>Start App:</p>
<p>  <code>rabbitmqctl start_app</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Starting node rabbit@rabbitmq02 ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>After you done, you will see:</p>
<p>  <img src="/../images/002.Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-compose/002-image%201.png" alt="Untitled"></p>
</li>
</ul>
<h2 id="Build-RabbitMQ-cluster-through-docker-composer"><a href="#Build-RabbitMQ-cluster-through-docker-composer" class="headerlink" title="Build RabbitMQ cluster through docker-composer"></a>Build RabbitMQ cluster through docker-composer</h2><hr>
<h3 id="First-let’s-look-at-dockerthe-compose-yml"><a href="#First-let’s-look-at-dockerthe-compose-yml" class="headerlink" title="First, let’s look at  dockerthe -compose.yml"></a>First, let’s look at  <code>dockerthe -compose.yml</code></h3><p>We make all services on same network, so we don’t need to handle hosts.</p>
<p>There are two types of rabbitmq service: master and slave, and use two different Dockerfile: <code>Dockerfile-master</code>, <code>Dockerfile-slave</code></p>
<p>We volume  <code>/etc/rabbitmq/enabled_plugins</code> to control what plugin we open.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">mqNetwork:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">rabbitmq-cluster-01:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./rabbitmq</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-master</span></span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">        <span class="attr">RABBITMQ_VERSION:</span> <span class="number">3.9</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">15672</span><span class="string">:15672</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_NODENAME=rabbitmq</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_USER=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_PASS=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_NODENAME=rabbitmq@rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mqNetwork</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./rabbitmq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">rabbitmq-cluster-02:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./rabbitmq</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-slave</span></span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">        <span class="attr">RABBITMQ_VERSION:</span> <span class="number">3.9</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">rabbitmq-cluster-02</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rabbitmq-cluster-02</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">15673</span><span class="string">:15672</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_NODENAME=rabbitmq</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_USER=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_PASS=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTER_NODE_HOST_NAME=rabbitmq@rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mqNetwork</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./rabbitmq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">rabbitmq-cluster-03:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./rabbitmq</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-slave</span></span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">        <span class="attr">RABBITMQ_VERSION:</span> <span class="number">3.9</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">rabbitmq-cluster-03</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rabbitmq-cluster-03</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">15674</span><span class="string">:15672</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_NODENAME=rabbitmq</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_USER=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_PASS=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTER_NODE_HOST_NAME=rabbitmq@rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mqNetwork</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./rabbitmq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins</span></span><br><span class="line">	<span class="string">.</span></span><br><span class="line">  <span class="string">.</span></span><br><span class="line">  <span class="string">.</span></span><br></pre></td></tr></table></figure>

<h3 id="Second-let’s-look-at-two-types-of-Dockerfile-for-build-RabbitMQ"><a href="#Second-let’s-look-at-two-types-of-Dockerfile-for-build-RabbitMQ" class="headerlink" title="Second, let’s look at two types of Dockerfile for build RabbitMQ :"></a>Second, let’s look at two types of Dockerfile for build RabbitMQ :</h3><p><code>Dockerfile-master</code></p>
<ul>
<li>Copy <code>.erlang.cookie</code> to <code>/var/lib/rabbitmq/.erlang.cookie</code> , so all of rabbitmq services have same <code>.erlang.cookie</code> .</li>
<li><code>[master.sh](http://master.sh)</code>  is start script for  master node.</li>
</ul>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> RABBITMQ_VERSION</span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> rabbitmq:$RABBITMQ_VERSION-management</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> .erlang.cookie /var/lib/rabbitmq/.erlang.cookie</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> master.sh /usr/local/bin/</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [ <span class="string">&quot;/usr/local/bin/docker-entrypoint.sh&quot;</span> ]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">chmod</span> 400 /var/lib/rabbitmq/.erlang.cookie &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    /usr/local/bin/master.sh</span></span><br></pre></td></tr></table></figure>

<p><code>Dockerfile-slave</code></p>
<ul>
<li>Copy <code>.erlang.cookie</code> to <code>/var/lib/rabbitmq/.erlang.cookie</code> , so all of rabbitmq services have same <code>.erlang.cookie</code> .</li>
<li><code>[slave.sh](http://slave.sh)</code> is start script for slave node.</li>
<li><code>tail -f /dev/null</code> is for keeping container running.</li>
</ul>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> RABBITMQ_VERSION</span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> rabbitmq:$RABBITMQ_VERSION-management</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> .erlang.cookie /var/lib/rabbitmq/.erlang.cookie</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> slave.sh /usr/local/bin/</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [ <span class="string">&quot;/usr/local/bin/docker-entrypoint.sh&quot;</span> ]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">chmod</span> 400 /var/lib/rabbitmq/.erlang.cookie &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    /usr/local/bin/slave.sh &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">tail</span> -f /dev/null</span></span><br></pre></td></tr></table></figure>

<h3 id="Third-two-types-of-start-script-master-sh-http-master-sh-slave-sh"><a href="#Third-two-types-of-start-script-master-sh-http-master-sh-slave-sh" class="headerlink" title="Third, two types of start script: [master.sh](http://master.sh) , slave.sh"></a>Third, two types of start script: <code>[master.sh](http://master.sh)</code> , <code>slave.sh</code></h3><p><code>master.sh</code></p>
<ul>
<li>master node just need to start server  —  start  erlang runtime and rabbitmq node</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># start rabbitmq service </span></span><br><span class="line">rabbitmq-server</span><br></pre></td></tr></table></figure>

<p><code>slave.sh</code></p>
<ul>
<li>slave node start rabbitmq-server first and sleep sometime to make sure erlang runtime and rabbitmq node is prepared.</li>
<li>execute  <code>stop_app</code>  to stop rabbitmq node and execute  <code>join_cluster</code>  to  become a member of the cluster</li>
<li>execute <code>start_app</code> to start rabbitmq node again.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># start rabbitmq service in backgorund (erlang node and rabbitmq application , detached mean in background)</span></span><br><span class="line">rabbitmq-server -detached</span><br><span class="line"></span><br><span class="line"><span class="built_in">sleep</span> 15s</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stops the RabbitMQ application, leaving the runtime (Erlang VM) running</span></span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line"></span><br><span class="line"><span class="comment"># Instructs the node to become a member of the cluster that the specified node is in</span></span><br><span class="line">rabbitmqctl join_cluster <span class="variable">$&#123;MASTER_NODE_HOST_NAME&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># start rabbitmq application 來 sync 資料</span></span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></table></figure>

<h3 id="Dependence"><a href="#Dependence" class="headerlink" title="Dependence"></a>Dependence</h3><ul>
<li>As a master node, rabbitmq-cluster-01 must start up first, and then other slave nodes like rabbitmq-cluster-02,  rabbitmq-cluster-03 … etc.</li>
<li>HAProxy should start up after all rabbitmq-cluster started up.</li>
</ul>
<h2 id="Add-HAProxy-as-load-balance"><a href="#Add-HAProxy-as-load-balance" class="headerlink" title="Add HAProxy as load balance."></a>Add HAProxy as load balance.</h2><hr>
<p><code>docker-compose.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">mqNetwork:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">	<span class="string">.</span></span><br><span class="line">	<span class="string">.</span> </span><br><span class="line">	<span class="string">.</span></span><br><span class="line">	<span class="attr">haproxy:</span></span><br><span class="line">	    <span class="attr">build:</span> </span><br><span class="line">	        <span class="attr">context:</span> <span class="string">./haproxy</span></span><br><span class="line">	        <span class="attr">args:</span> </span><br><span class="line">	          <span class="attr">HAPROXY_VERSION:</span> <span class="string">$&#123;HAPROXY_VERSION&#125;</span></span><br><span class="line">	    <span class="attr">container_name:</span> <span class="string">haproxy</span></span><br><span class="line">	    <span class="attr">ports:</span></span><br><span class="line">	      <span class="bullet">-</span> <span class="number">5672</span><span class="string">:5672</span></span><br><span class="line">	      <span class="bullet">-</span> <span class="number">8100</span><span class="string">:8100</span></span><br><span class="line">	    <span class="attr">depends_on:</span></span><br><span class="line">	      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">	      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-02</span></span><br><span class="line">	      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-03</span></span><br><span class="line">				<span class="bullet">-</span> <span class="string">rabbitmq-cluster-04</span></span><br><span class="line">	      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-05</span></span><br><span class="line">	    <span class="attr">networks:</span></span><br><span class="line">	      <span class="bullet">-</span> <span class="string">mqNetwork</span></span><br><span class="line">	    <span class="attr">volumes:</span></span><br><span class="line">	     <span class="bullet">-</span> <span class="string">./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg</span></span><br></pre></td></tr></table></figure>

<h3 id="Dockerfile-for-haproxy"><a href="#Dockerfile-for-haproxy" class="headerlink" title="Dockerfile for haproxy"></a>Dockerfile for haproxy</h3><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> HAPROXY_VERSION</span><br><span class="line"><span class="keyword">FROM</span> haproxy:$HAPROXY_VERSION</span><br></pre></td></tr></table></figure>

<h3 id="haproxy-cfg"><a href="#haproxy-cfg" class="headerlink" title="haproxy.cfg"></a>haproxy.cfg</h3><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#--------------------------------------------------------------------- </span></span><br><span class="line"><span class="comment"># common defaults that all the &#x27;listen&#x27; and &#x27;backend&#x27; sections will </span></span><br><span class="line"><span class="comment"># use if not designated in their block </span></span><br><span class="line"><span class="comment">#--------------------------------------------------------------------- </span></span><br><span class="line">global</span><br><span class="line">daemon</span><br><span class="line"></span><br><span class="line">    defaults</span><br><span class="line">    mode tcp</span><br><span class="line">    maxconn <span class="number">10000</span></span><br><span class="line">    timeout connect <span class="number">5</span>s</span><br><span class="line">    timeout client <span class="number">100</span>s</span><br><span class="line">    timeout server <span class="number">100</span>s</span><br><span class="line"></span><br><span class="line">frontend stats</span><br><span class="line">    *bind *:<span class="number">8100</span>*</span><br><span class="line">    mode http</span><br><span class="line">    stats enable</span><br><span class="line">    stats uri /stats</span><br><span class="line">    stats refresh <span class="number">10</span>s</span><br><span class="line">    stats admin if LOCALHOST</span><br><span class="line"></span><br><span class="line">frontend rabbitmq</span><br><span class="line">    bind *:<span class="number">5672</span></span><br><span class="line">    use_backend rabbitmq-server</span><br><span class="line"></span><br><span class="line">backend rabbitmq-server</span><br><span class="line">    balance roundrobin</span><br><span class="line">    server rabbitmaster rabbitmq-cluster-<span class="number">01</span>:<span class="number">5672</span> check inter <span class="number">5</span>s rise <span class="number">2</span> fall <span class="number">3</span></span><br><span class="line">    server rabbitslave1 rabbitmq-cluster-<span class="number">02</span>:<span class="number">5672</span> check inter <span class="number">5</span>s rise <span class="number">2</span> fall <span class="number">3</span></span><br><span class="line">	  server rabbitslave2 rabbitmq-cluster-<span class="number">03</span>:<span class="number">5672</span> check inter <span class="number">5</span>s rise <span class="number">2</span> fall <span class="number">3</span></span><br><span class="line">    server rabbitslave3 rabbitmq-cluster-<span class="number">04</span>:<span class="number">5672</span> check inter <span class="number">5</span>s rise <span class="number">2</span> fall <span class="number">3</span></span><br><span class="line">    server rabbitslave4 rabbitmq-cluster-<span class="number">05</span>:<span class="number">5672</span> check inter <span class="number">5</span>s rise <span class="number">2</span> fall <span class="number">3</span></span><br></pre></td></tr></table></figure>

<h2 id="Completed-docker-compose-yml-and-directory-structure"><a href="#Completed-docker-compose-yml-and-directory-structure" class="headerlink" title="Completed docker-compose.yml and directory structure"></a>Completed <code>docker-compose.yml</code> and directory structure</h2><hr>
<h3 id="Completed-docker-compose-yml"><a href="#Completed-docker-compose-yml" class="headerlink" title="Completed docker-compose.yml"></a>Completed <code>docker-compose.yml</code></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">mqNetwork:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">rabbitmq-cluster-01:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./rabbitmq</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-master</span></span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">        <span class="attr">RABBITMQ_VERSION:</span> <span class="number">3.9</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">15672</span><span class="string">:15672</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_NODENAME=rabbitmq</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_USER=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_PASS=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_NODENAME=rabbitmq@rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mqNetwork</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./rabbitmq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">rabbitmq-cluster-02:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./rabbitmq</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-slave</span></span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">        <span class="attr">RABBITMQ_VERSION:</span> <span class="number">3.9</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">rabbitmq-cluster-02</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rabbitmq-cluster-02</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">15673</span><span class="string">:15672</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_NODENAME=rabbitmq</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_USER=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_PASS=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTER_NODE_HOST_NAME=rabbitmq@rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mqNetwork</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./rabbitmq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">rabbitmq-cluster-03:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./rabbitmq</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-slave</span></span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">        <span class="attr">RABBITMQ_VERSION:</span> <span class="number">3.9</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">rabbitmq-cluster-03</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rabbitmq-cluster-03</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">15674</span><span class="string">:15672</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_NODENAME=rabbitmq</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_USER=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_PASS=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTER_NODE_HOST_NAME=rabbitmq@rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mqNetwork</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./rabbitmq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">rabbitmq-cluster-04:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./rabbitmq</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-slave</span></span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">        <span class="attr">RABBITMQ_VERSION:</span> <span class="number">3.9</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">rabbitmq-cluster-04</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rabbitmq-cluster-04</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">15675</span><span class="string">:15672</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_NODENAME=rabbitmq</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_USER=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_PASS=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTER_NODE_HOST_NAME=rabbitmq@rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mqNetwork</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./rabbitmq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">rabbitmq-cluster-05:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./rabbitmq</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-slave</span></span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">        <span class="attr">RABBITMQ_VERSION:</span> <span class="number">3.9</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">rabbitmq-cluster-05</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rabbitmq-cluster-05</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">15676</span><span class="string">:15672</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_NODENAME=rabbitmq</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_USER=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RABBITMQ_DEFAULT_PASS=guest</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTER_NODE_HOST_NAME=rabbitmq@rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mqNetwork</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./rabbitmq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">haproxy:</span></span><br><span class="line">    <span class="attr">build:</span> </span><br><span class="line">        <span class="attr">context:</span> <span class="string">./haproxy</span></span><br><span class="line">        <span class="attr">args:</span> </span><br><span class="line">          <span class="attr">HAPROXY_VERSION:</span> <span class="string">$&#123;HAPROXY_VERSION&#125;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">haproxy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5672</span><span class="string">:5672</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8100</span><span class="string">:8100</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-01</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-02</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-04</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rabbitmq-cluster-05</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mqNetwork</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg</span></span><br></pre></td></tr></table></figure>

<h3 id="Directory-Structure"><a href="#Directory-Structure" class="headerlink" title="Directory Structure"></a>Directory Structure</h3><p><img src="/../images/002.Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-compose/002-image%202.png" alt="Untitled"></p>
<h2 id="Build-by-docker-compose"><a href="#Build-by-docker-compose" class="headerlink" title="Build by docker-compose"></a>Build by docker-compose</h2><hr>
<ul>
<li><p><code>docker-compose up -d</code></p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[+] Building 2.7s (27/33)</span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-05 internal] load build definition from Dockerfil  0.0s </span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 409B                                                          0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-02 internal] load build definition from Dockerfil  0.0s </span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 409B                                                          0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-01 internal] load build definition from Dockerfil  0.0s </span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 384B                                                          0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-03 internal] load build definition from Dockerfil  0.0s </span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 409B                                                          0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_haproxy internal] load build definition from Dockerfile             0.0s </span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 87B                                                           0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-04 internal] load build definition from Dockerfil  0.1s </span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 409B                                                          0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-05 internal] load .dockerignore                    0.0s </span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                               0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-02 internal] load .dockerignore                    0.0s </span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                               0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-01 internal] load .dockerignore                    0.0s </span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                               0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-03 internal] load .dockerignore                    0.0s </span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                               0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_haproxy internal] load .dockerignore                                0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                               0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-04 internal] load .dockerignore                    0.0s </span><br><span class="line"> =&gt; =&gt; transferring context: 2B                                                               0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-04 internal] load metadata <span class="keyword">for</span> docker.io/library/  0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-04 1/4] FROM docker.io/library/rabbitmq:3.9-manag  0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-05 internal] load build context                    0.0s </span><br><span class="line"> =&gt; =&gt; transferring context: 530B                                                             0.0s </span><br><span class="line"> =&gt; CACHED [rabbitmq-cluster-env_rabbitmq-cluster-01 2/4] RUN <span class="built_in">echo</span> <span class="string">&quot;Build version: 3.9.13&quot;</span>    0.0s </span><br><span class="line"> =&gt; CACHED [rabbitmq-cluster-env_rabbitmq-cluster-05 3/4] COPY .erlang.cookie /var/lib/rabbi  0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-05 4/4] COPY slave.sh /usr/local/bin/              0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-02 internal] load build context                    0.0s </span><br><span class="line"> =&gt; =&gt; transferring context: 530B                                                             0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-01 internal] load build context                    0.0s </span><br><span class="line"> =&gt; =&gt; transferring context: 210B                                                             0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_haproxy] exporting to image                                         0.2s </span><br><span class="line"> =&gt; =&gt; exporting layers                                                                       0.0s </span><br><span class="line"> =&gt; =&gt; writing image sha256:7cb933b9ff00e6c50cc84042063f5df6bcb118b205b64096a4c6fdf8dc6b297c  0.0s </span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/rabbitmq-cluster-env_rabbitmq-cluster-05                   0.0s </span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/rabbitmq-cluster-env_rabbitmq-cluster-02                   0.0s </span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/rabbitmq-cluster-env_rabbitmq-cluster-03                   0.0s </span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/rabbitmq-cluster-env_rabbitmq-cluster-04                   0.0s </span><br><span class="line"> =&gt; =&gt; writing image sha256:de6b6cf48cfa0b1123f4fc2922ad1f116528b766c7850f856c6ce5220bade7b6  0.0s </span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/rabbitmq-cluster-env_rabbitmq-cluster-01                   0.0s </span><br><span class="line"> =&gt; =&gt; writing image sha256:274925b27a9e25ff77b491434e1e96255a3ef882038e88a3aa75be4990ffd1e6  0.0s </span><br><span class="line"> =&gt; =&gt; naming to docker.io/library/rabbitmq-cluster-env_haproxy                               0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-03 internal] load build context                    0.1s </span><br><span class="line"> =&gt; =&gt; transferring context: 530B                                                             0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_haproxy internal] load metadata <span class="keyword">for</span> docker.io/library/haproxy:2.3   2.2s </span><br><span class="line"> =&gt; CACHED [rabbitmq-cluster-env_rabbitmq-cluster-01 3/4] COPY .erlang.cookie /var/lib/rabbi  0.0s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-01 4/4] COPY master.sh /usr/local/bin/             0.1s </span><br><span class="line"> =&gt; [rabbitmq-cluster-env_rabbitmq-cluster-04 internal] load build context                    0.1s </span><br><span class="line"> =&gt; =&gt; transferring context: 530B                                                             0.0s </span><br><span class="line"> =&gt; CACHED [rabbitmq-cluster-env_haproxy 1/1] FROM docker.io/library/haproxy:2.3@sha256:7a9b  0.0s</span><br><span class="line"></span><br><span class="line">[+] Running 7/7</span><br><span class="line"> - Network rabbitmq-cluster-env_mqNetwork  Create...                                          0.7s </span><br><span class="line"> - Container rabbitmq-cluster-01           Started                                            2.5s</span><br><span class="line"> - Container rabbitmq-cluster-02           Started                                            6.4s</span><br><span class="line"> - Container rabbitmq-cluster-04           Started                                            5.3s </span><br><span class="line"> - Container rabbitmq-cluster-03           Started                                            5.1s </span><br><span class="line"> - Container rabbitmq-cluster-05           Started                                            6.1s </span><br><span class="line"> - Container haproxy                       Started                                            8.0s</span><br></pre></td></tr></table></figure>
</li>
<li><p>Check RabbitMQ management GUI:  <a target="_blank" rel="noopener" href="http://localhost:15672/#/">http://127.0.0.1:15672/</a></p>
<p>  <img src="/../images/002.Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-compose/002-image%203.png" alt="Untitled"></p>
</li>
<li><p>Check  HAProxy stats page: <a target="_blank" rel="noopener" href="http://127.0.0.1:8100/stats">http://127.0.0.1:8100/stats</a></p>
<p>  <img src="/../images/002.Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-compose/002-image%204.png" alt="Untitled"></p>
</li>
</ul>
<h2 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h2><hr>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/chun-hunag/rabbitmq-sample/tree/main/rabbitmq-cluster-env">Github Link</a></li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><hr>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/clustering.html">https://www.rabbitmq.com/clustering.html</a></li>
<li><a target="_blank" rel="noopener" href="http://kuma-uni.blogspot.com/2017/03/rabbitmqha-rabbitmq-1.html">http://kuma-uni.blogspot.com/2017/03/rabbitmqha-rabbitmq-1.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.yowko.com/docker-compose-rabbitmq-cluster/">https://blog.yowko.com/docker-compose-rabbitmq-cluster/</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/RabbitMQ/" rel="tag"># RabbitMQ</a>
              <a href="/tags/Docker/" rel="tag"># Docker</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/how-to-build-blog-by-hexo-with-theme-%E2%80%9Cnext/" rel="prev" title="How to build blog by hexo with theme “next"">
      <i class="fa fa-chevron-left"></i> How to build blog by hexo with theme “next"
    </a></div>
      <div class="post-nav-item">
    <a href="/declare-quorum-queue-with-go-language/" rel="next" title="Declare Quorum queue with go language">
      Declare Quorum queue with go language <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Build-a-RabbitMQ-cluster-including-HAPorxy-by-docker-composer"><span class="nav-number">1.</span> <span class="nav-text">Build a RabbitMQ cluster including HAPorxy by docker-composer</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Why-do-we-need-a-RabbitMQ-cluster"><span class="nav-number">1.1.</span> <span class="nav-text">Why do we need a RabbitMQ cluster?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-many-ways-we-can-build-RabbitMQ-cluster"><span class="nav-number">1.2.</span> <span class="nav-text">How many ways we can build  RabbitMQ cluster ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Some-things-we-need-to-know-before-starting"><span class="nav-number">1.3.</span> <span class="nav-text">Some things we need to know before starting</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Build-RabbitMQ-cluster-through-rabbitmqctl-manually"><span class="nav-number">1.4.</span> <span class="nav-text">Build RabbitMQ cluster through rabbitmqctl manually</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Run-three-RabbitMQ-container"><span class="nav-number">1.4.1.</span> <span class="nav-text">Run three RabbitMQ container</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Check-Management-UI"><span class="nav-number">1.4.2.</span> <span class="nav-text">Check Management UI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Get-IP-of-rabbitmq-containers"><span class="nav-number">1.4.3.</span> <span class="nav-text">Get IP of rabbitmq containers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Add-IP-to-container%E2%80%99s-hosts"><span class="nav-number">1.4.4.</span> <span class="nav-text">Add IP to container’s hosts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ-2-and-3-join-cluster"><span class="nav-number">1.4.5.</span> <span class="nav-text">RabbitMQ 2 and 3 join cluster</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Build-RabbitMQ-cluster-through-docker-composer"><span class="nav-number">1.5.</span> <span class="nav-text">Build RabbitMQ cluster through docker-composer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#First-let%E2%80%99s-look-at-dockerthe-compose-yml"><span class="nav-number">1.5.1.</span> <span class="nav-text">First, let’s look at  dockerthe -compose.yml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Second-let%E2%80%99s-look-at-two-types-of-Dockerfile-for-build-RabbitMQ"><span class="nav-number">1.5.2.</span> <span class="nav-text">Second, let’s look at two types of Dockerfile for build RabbitMQ :</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Third-two-types-of-start-script-master-sh-http-master-sh-slave-sh"><span class="nav-number">1.5.3.</span> <span class="nav-text">Third, two types of start script: [master.sh](http:&#x2F;&#x2F;master.sh) , slave.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dependence"><span class="nav-number">1.5.4.</span> <span class="nav-text">Dependence</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Add-HAProxy-as-load-balance"><span class="nav-number">1.6.</span> <span class="nav-text">Add HAProxy as load balance.</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile-for-haproxy"><span class="nav-number">1.6.1.</span> <span class="nav-text">Dockerfile for haproxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#haproxy-cfg"><span class="nav-number">1.6.2.</span> <span class="nav-text">haproxy.cfg</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Completed-docker-compose-yml-and-directory-structure"><span class="nav-number">1.7.</span> <span class="nav-text">Completed docker-compose.yml and directory structure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Completed-docker-compose-yml"><span class="nav-number">1.7.1.</span> <span class="nav-text">Completed docker-compose.yml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Directory-Structure"><span class="nav-number">1.7.2.</span> <span class="nav-text">Directory Structure</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Build-by-docker-compose"><span class="nav-number">1.8.</span> <span class="nav-text">Build by docker-compose</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-Code"><span class="nav-number">1.9.</span> <span class="nav-text">Source Code</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">1.10.</span> <span class="nav-text">Reference</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="jam huang"
      src="/images/Tombili_mini.jpg">
  <p class="site-author-name" itemprop="name">jam huang</p>
  <div class="site-description" itemprop="description">Share tech notes and investment experience</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/chun-hunag" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chun-hunag" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hgfrttlk@gmail.com" title="E-Mail → mailto:hgfrttlk@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/%E4%BF%8A%E7%91%9D-%E9%BB%83-554b02120" title="Linkedin → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;%E4%BF%8A%E7%91%9D-%E9%BB%83-554b02120" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fab fa-connectdevelop"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jam huang</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  

    </div>
</body>
</html>
